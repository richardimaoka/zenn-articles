---
title: "ã‚³ãƒ”ãƒšã§å­¦ã¶ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«: ã‚µãƒ¼ãƒãƒ¼å¾…ã¡ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’Apollo Client + Reactã§è¡Œã†"
emoji: "ğŸ·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢h" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["GraphQL"]
published: false
---

## å°å…¥

Apollo Client ã§æ§‹ç¯‰ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã€ GraphQL ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”å¾…ã¡ã®é–“ã«ã€ã„ã‚ã‚†ã‚‹ã€Œã‚¹ãƒ”ãƒŠãƒ¼ã€ãªã©ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’è¡Œã„ãŸã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

https://youtu.be/6ZIySVuxsCU

ãã“ã§æœ¬è¨˜äº‹ã§ã¯ Apollo Client ã® API ã«æ²¿ã£ãŸå½¢ã§ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚æ‰‹ã‚’å‹•ã‹ã—ã¦å‹•ä½œç¢ºèªã§ãã‚‹ã¨ç†è§£ãŒã—ã‚„ã™ã„ã‹ã¨æ€ã„ã€ã‚³ãƒ”ãƒšã ã‘ã§ç°¡å˜ã«å­¦ã¹ã‚‹ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«ã—ã¦ã„ã¾ã™ã€‚

:::details React Suspense ã¯ä½¿ã‚ãªã„ã®ï¼Ÿ
ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’è¡Œã„ãŸã„å ´åˆã€React 18 ä»¥é™ã§ã¯[Suspense](https://reactjs.org/blog/2022/03/29/react-v18.html#suspense-in-data-frameworks)ãŒé¸æŠè‚¢ã«ä¸ŠãŒã‚‹ã§ã—ã‚‡ã†ã€‚ã¨ã“ã‚ãŒã€[GitHub: apollo-client - Adding React suspense + data fetching support](https://github.com/apollographql/apollo-client/issues/9627)ã«ã‚ã‚‹ã‚ˆã†ã«ã€Apollo Client å…¬å¼ã§ã¯ã¾ã  Suspense ã¨ã®çµ±åˆæ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã›ã‚“ã€‚

Apollo Client å…¬å¼ãŒæ¨å¥¨ã™ã‚‹æ–¹æ³•ãŒæ±ºã¾ã‚‹ã¾ã§ã¯ã€æœ¬è¨˜äº‹ã®ã‚ˆã†ã« Suspense ã‚’ä½¿ã‚ãªã„å¾“æ¥ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãŒå‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚
:::

## äº‹å‰æº–å‚™

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ä½œæˆã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®æ§‹æˆã¯ã“ã¡ã‚‰ã§ã™ã€‚

![apollo-client-loading-architecture](/images/26a9ec78c43463/apollo-client-loading-architecture.png)

ã“ã¡ã‚‰ã®æ§‹æˆã‚’ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### äº‹å‰æº–å‚™ 1. ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

ã¾ãšã¯æœ¬ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚

```sh:ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
mkdir tutorial-apollo-client-loadinã€‚
cd tutorial-apollo-client-loading
```

å…¨ä½“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯æœ€çµ‚çš„ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```:ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
tutorial-apollo-client-loading
  +- server  # Apollo GraphQL Server
  +- client  # React Client
```

ãã‚Œã§ã¯æ¬¡ã®æ‰‹é †ã§ã€ä¸Šè¨˜ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã®ã†ã¡ã€`server`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ä½œæˆã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### äº‹å‰æº–å‚™ 2. GraphQL ã‚µãƒ¼ãƒãƒ¼

GraphQL ã‚µãƒ¼ãƒãƒ¼ã‚’æº–å‚™ã—ã¾ã™ã€‚

```sh:ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
# ä¸€åº¦ã«å…¨éƒ¨ã‚³ãƒ”ãƒšã§å®Ÿè¡Œã§ãã¾ã™
mkdir server
cd server

# node.js setup
npm init -y
echo "node_modules" > .gitignore
```

TypeScript ã‚’å°å…¥ã—ã¦ã€ts-node-dev ã§ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç«‹ã¡ä¸Šã’ã‚‹æº–å‚™ã‚’ã—ã¾ã—ã‚‡ã†ã€‚

```sh:ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
# install and initialize typescript
npm install --save-dev typescript
npx tsc --init

# ts-node-dev: watch and restart a TypeScript server
npm install --save-dev ts-node-dev
npm pkg set scripts.start="ts-node-dev --watch src/*,data/*,./schema.gql --respawn src/index.ts"
```

Apollo Server ã¨ GraphQL Codegen ã‚’å°å…¥ã—ã¾ã™ã€‚

```sh:ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
# apollo server
npm install apollo-server graphql

# install and setup graphql-codegen
npm install --save-dev @graphql-codegen/cli

# ã“ã“ã§ npx graphql-code-generator init ã‚’è¡Œã‚ãšã€å¾Œã§codegen.tsã‚’ç”Ÿæˆã€‚ç†ç”±ã¯å¾Œè¿°ã€‚
npm install --save-dev \
  @graphql-codegen/typescript \
  @graphql-codegen/typescript-resolvers

npm pkg set scripts.generate="graphql-codegen --config codegen.yml --watch ./schema.gql,./data/*" # update generate script
```

`@graphql-codegen/cli`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸå¾Œã€é€šå¸¸ã¯ã‚³ãƒãƒ³ãƒ‰`npx graphql-code-generator init`ã«ã‚ˆã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«`codegen.ts`ã‚’ç”Ÿæˆã—ã¾ã™ãŒã€ãã†ã™ã‚‹ã¨å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã£ã¦ã—ã¾ã„æ‰‹å…¥åŠ›ãŒå¢—ãˆã‚‹ã®ã¨ã€çµå±€ã¯ç”Ÿæˆã•ã‚ŒãŸ config.ts ã‚’ä¸Šæ›¸ãå¤‰æ›´ã™ã‚‹ã“ã¨ã«ãªã‚‹ã®ã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ config.ts ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts
cat << EOF > codegen.ts;
import type { CodegenConfig } from "@graphql-codegen/cli";

const config: CodegenConfig = {
  overwrite: true,
  schema: "schema.gql",
  generates: {
    "src/generated/graphql.ts": {
      plugins: ["typescript", "typescript-resolvers"],
      config: {
        avoidOptionals: true,
      },
    },
  },
  hooks: {
    afterOneFileWrite: ["npx prettier --write"],
  },
};

export default config;
EOF;
```

```sh:ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
# é–‹ç™ºãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
# ã“ã†ã—ãªã„ã¨ã€æ¬¡ã®git applyãŒé™ã‹ã«å¤±æ•—ã™ã‚‹å¯èƒ½æ€§ã‚ã‚Š
cd ../

curl https://github.com/richardimaoka/tutorial-apollo-client-loading/commit/65243e4ea244df1fd0bac1aeda9030643278e16c.patch \
  | git apply -v -
```

### äº‹å‰æº–å‚™ 3. React ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

```sh:ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
npx create-react-app client --template typescript

cd client
npx prettier --write .
```

```sh:ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
# apollo client
npm install @apollo/client graphql

# install and setup graphql-codegen
npm install --save-dev @graphql-codegen/cli

# ã“ã“ã§ npx graphql-code-generator init ã‚’è¡Œã‚ãšã€å¾Œã§codegen.tsã‚’ç”Ÿæˆã€‚ç†ç”±ã¯å¾Œè¿°ã€‚
npm install --save-dev \
  @graphql-codegen/typescript-operations \
  @graphql-codegen/typescript \
  @graphql-codegen/typescript-react-apollo

npm pkg set scripts.codegen="graphql-codegen --config codegen.ts --watch src/\\*_/_.tsx,../server/schema.gql"
```

`@graphql-codegen/cli`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸå¾Œã€é€šå¸¸ã¯ã‚³ãƒãƒ³ãƒ‰`npx graphql-code-generator init`ã«ã‚ˆã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«`codegen.ts`ã‚’ç”Ÿæˆã—ã¾ã™ãŒã€ãã†ã™ã‚‹ã¨å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã£ã¦ã—ã¾ã„æ‰‹å…¥åŠ›ãŒå¢—ãˆã‚‹ã®ã¨ã€çµå±€ã¯ç”Ÿæˆã•ã‚ŒãŸ config.ts ã‚’ä¸Šæ›¸ãå¤‰æ›´ã™ã‚‹ã“ã¨ã«ãªã‚‹ã®ã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ config.ts ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts:ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
cat << EOF > codegen.ts
import type { CodegenConfig } from "@graphql-codegen/cli";

const config: CodegenConfig = {
  overwrite: true,
  schema: "../server/schema.gql",
  documents: "src/**/*.tsx",
  generates: {
    "src/generated/graphql.ts": {
      plugins: [
        "typescript",
        "typescript-operations",
        "typescript-react-apollo",
      ],
      config: {
        avoidOptionals: true,
      },
    },
  },
  hooks: {
    afterOneFileWrite: ["npx prettier --write"],
  },
};

export default config;
EOF
```

ç¶šã„ã¦ã€å¾Œã»ã©ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ã®ã«åˆ©ç”¨ã™ã‚‹ FontAwesome ã‚‚å°å…¥ã—ã¾ã—ã‚‡ã†ã€‚[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® React ç”¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †](https://fontawesome.com/docs/web/use-with/react/)ã«å¾“ã£ã¦ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```sh:ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
# Add SVG Core
npm i --save @fortawesome/fontawesome-svg-core

# Add Icon Packages
npm i --save @fortawesome/free-solid-svg-icons
npm i --save @fortawesome/free-regular-svg-icons

# Add the React Component
npm i --save @fortawesome/react-fontawesome@latest
```

```sh:ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
# é–‹ç™ºãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
# ã“ã†ã—ãªã„ã¨ã€æ¬¡ã®git applyãŒé™ã‹ã«å¤±æ•—ã™ã‚‹å¯èƒ½æ€§ã‚ã‚Š
cd ../

curl https://github.com/richardimaoka/tutorial-apollo-client-loading/commit/aba557674d984551b8533d5b5b6cdd10109d9ae7.patch \
  | git apply -v -
```

## ãƒ—ãƒ­ã‚»ã‚¹ç«‹ã¡ä¸Šã’

4 ã¤ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç«‹ã¡ä¸Šã’ã¾ã™

![terminals](/images/26a9ec78c43463/terminals.png)

```sh:ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
cd server
npm run codegen
```

```sh:ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
cd server
npm start
```

```sh:ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
cd client
npm run codegen
```

```sh:ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
cd client
npm start
```

## é…å»¶ã®ãªã„å ´åˆã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ä½œã‚‹å‰ã«ã€é…å»¶ã®ãªã„å ´åˆã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚ã”ãç°¡å˜ãªäººç‰©ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ 3 äººåˆ†è¡¨ç¤ºã—ã¦ã¿ã¾ã™ã€‚

![faces](/images/26a9ec78c43463/faces.png)

```sh:
command...
```

## é…å»¶ãŒã‚ã‚‹å ´åˆã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º

ã„ã‚ˆã„ã‚ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã§ã™ã€‚

### ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã«é…å»¶ã‚’æŒ¿å…¥

```sh:
command...
```

```ts:
search: async (_parent, _args, context, _info) => {
  console.log("waiting started");
  await setTimeout(3000, null);
  console.log("waiting ended");
  return context.Query.search;
},
```

Apollo Studio ã‹ã‚‰ãŸã‚ã™

![placeholder](/images/26a9ec78c43463/placeholder.png)

```gql
query {
}
```

animated GIF

![placeholder](/images/26a9ec78c43463/placeholder.png)

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’å°å…¥

```sh:
command...
```

```ts:
if (loading) {
  return (
    <div>
      <FontAwesomeIcon icon={faSpinner} size={"4x"} spin={true} />
    </div>
  );
}
```

![spinner](/images/26a9ec78c43463/Spinner.gif)
