---
title: "Reactアプリ上でソースコードを色つき表示するならOSSライブラリ? Prism.js? Highlight.js? それとも？"
emoji: "🐷"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["React"]
published: false
---

## 導入

ソースコードを色つき表示することは、視覚的な美しさのみならず、ユーザーにとっての読みやすさのためにとても重要です。

本記事では React アプリケーション上でソースコードを色つき表示するために使えるライブラリ、ツールなどの選択肢の中からひとつを選ぶため

- どうやって選択肢を絞り込むかの**判断基準**
- 色つき表示を行う、**主なライブラリやツール**

を紹介します。

## ソースコードをハイライトする仕組み

React アプリケーション上でソースコードを表示する場合、多くの開発者が一番最初に`<pre><code>`タグを思い浮かべると思います。しかし、`<pre><code>`タグはレイアウトはしてくれるものの、色はつけてくれないので、そのままでは読みづらい表示になってしまいます。

```:色なし、<pre><code>だけで表示した「Go言語のhello world」
package main

import "fmt"

func main() {
    fmt.Println("hello world")
}
```

```go:色つきとの比較
package main

import "fmt"

func main() {
    fmt.Println("hello world")
}
```

React に限りませんが、HTML と CSS を使ってソースコードを色つき表示するには、ソースコード内の単語一つ一つを`<span>`で囲んで、`class`など (React の JSX では`className`) によって CSS を適用します。

```html:HTMLとCSSでハイライトするためには<span>で囲む
<pre>
  <code className="language-go code-line" data-line="26">
    <span className="token keyword">package</span> main
    <span className="token keyword">import</span> <span className="token string">"fmt"</span>
    <span className="token keyword">func</span> <span className="token function">main</span><span className="token punctuation">(</span><span className="token punctuation">)</span> <span className="token punctuation">{</span>
        fmt<span className="token punctuation">.</span><span className="token function">Println</span><span className="token punctuation">(</span><span className="token string">"hello world"</span><span className="token punctuation">)</span>
    <span className="token punctuation">}</span>
  </code>
</pre>
```

当然ながら一つ一つの`<span>`を手作業で書くわけにはいかないので、何らかのライブラリやツールに頼ることになります。

## ライブラリやツールが多く迷ってしまうので、判断基準が必要

しかし、何らかのライブラリやツールに頼る際に選べる選択肢が多すぎることが React 開発者にとっての悩みになってしまいます。

- React Syntax Highlighter などのコンポーネント
- 伝統的な Prism.js や Highlight.js
- CodePen のような埋込サービス
- Monaco Editor などのブラウザ内エディタ

そこで本記事では、React 開発者の悩みを減らせるよう、これらの選択肢から一つを選び出すための判断基準を紹介します。

まず重要な判断基準が、ソースコードが Read-Only か？ Editable か？です。

![](https://storage.googleapis.com/zenn-user-upload/d80fc29e4dad-20240926.jpg)

Read-Only で十分であれば、React Syntax Highlighter のようなシンプルかつ効果的な選択肢が利用可能です。しかし、Read-Only ではなく Editable なソースコードを実現するツール群は、一般に使い方が複雑であったり、JavaScript のファイルサイズが大きくなりがちです。このため、自身が開発する React アプリケーションにおいて「本当に Editable である必要があるのか？」を慎重に検討することが求められます。実際、ユーザーが手動でソースコードを記述する必要性は、開発者が想定するほど多くはなく、ユーザーはブラウザ上でのソースコード記述を望まないものです。

次に考慮すべき重要な判断基準は、「現代の React に対応しやすいか？」という点です。現在の React アプリケーションでは、Server Side Rendering や将来的に普及が期待される Server Component など、サーバー側での処理が一般的です。そのため、Browser API に依存してクライアントサイドでのみレンダリングを行う選択肢は、開発者にとって扱いづらいと感じられることがあります。ただし、これらの選択肢が React に不向きだと一概に決めつける必要はありません。慎重に注意点を考慮した上で、利用判断を行うことが求められます。

## Read-Only 系の選択肢

テキストエディタを実装するのはとても大変であることが知られている。だから Read-Only だと決めてしまえば、導入が楽なツールを使える。

それでは各選択肢を紹介していきましょう。

### React Syntax Highlighter

- Read-Only な選択肢には ◎
- 一瞬で導入できる
- 現代的な React にも対応 ◎
- 色つき表示「以上」の機能を求めると足りないことも

React でソースコードを色つき表示 (Syntax Highlight) する OSS ライブラリとしては最も有名で、かつ本記事で紹介する選択肢の中でも最も導入が簡単なもののひとつです。

以下の npm コマンドを実行して

```
npm install react-syntax-highlighter --save
```

このようなコンポーネントを書けば、すぐに表示できてしまいます。

```js
import SyntaxHighlighter from "react-syntax-highlighter";
import { docco } from "react-syntax-highlighter/dist/esm/styles/hljs";

const Component = () => {
  const codeString = "(num) => num + 1";
  return (
    <SyntaxHighlighter language="javascript" style={docco}>
      {codeString}
    </SyntaxHighlighter>
  );
};
```

Browser API に依存していないので現代的な React にも対応ずみです。Server Side Rendering でも問題なく動作しますし、Next.js 14 以降では普通のコンポーネントを書くだけで自動的に Server Component として使うことができます。サーバー側での処理のみで完結してしまうので、hooks や状態管理など難しいことを考える必要もありません。Server Component によって React Syntax Highlighter の JavaScript bundle サイズを気にする必要もなくなります。

:::details bundle サイズ を気にして対象言語を絞り込む必要がなくなります
https://github.com/react-syntax-highlighter/react-syntax-highlighter?tab=readme-ov-file#light-build
:::

しかし、React Syntax Highlighter に備わっている機能を超える使い方をしようとすると苦労する場合があります。例えば「指定した行をハイライトしたい」というのはよくある要求ですが、React Syntax Highlighter は対応していません。自分で JavaScript を書いて機能を実現する必要があり、こちらの記事にあるような工夫が求められます。

TODO: 記事

また React Syntax Highlighter はソースコード表示部分に重ねるようにボタンやツールチップを配置するのが難しいため、こういった「自由自在に追加コンポーネントを配置する」場合には大体の選択肢が必要になってきます。

TODO: 画像

### Prism.js と Highlight.js

- Read-Only な選択肢には ◎
- 現代的な React 対応 △
- 結局 React Syntax Highlighter と同じものを再発明することになりがち

Prism.js と Highlight.js はソースコードの色つき表示のためのツールとしては最も有名な２つです。どちらも React 登場以前から存在し、安定した仕様と実装に加え、非常に幅広いユーザー層を抱えます。

実は React Syntax Highlighter も内部では Prism.js と Highlight.js を使っています。Prism.js か Highlight.js を直接使うよりは React Syntax Highlighter を経由して使うほうが、現代的な React への対応もでき、React アプリへの導入も簡単になります。そのため私の意見としては React アプリの中で Prism.js か Highlight.js を直接使う理由は乏しく、React Syntax Highlighter を使うことをおすすめします。

ここからは「それでも直接 Prism.js か Highlight.js を使うほうがシンプルで良いのでは？」と考える人のために、その際に考慮すべき課題を紹介します。

冒頭に記載の通り、ソースコードの色つき表示は`<pre><code>`タグで囲んだ内部に`<span>`タグを大量に追加する必要があるのですが、`<span>`タグの追加を全部自力で実装するのは大変です。Prism.js と Highlight.js はまさにその機能を提供してくれるツールです。

最も簡単な導入方法は HTML 内で`<link>`タグによる CSS 読み込み、`<script>`タグによる JavaScript の読み込みを行うだけです。以下は導入方法を省略した形ですが、完全なものでも数行で済んでしまいます。

```html
<link href="themes/prism.css" rel="stylesheet" />
...
<!-- HTML内のすべての<pre><code>を色つき表示 -->
<script src="prism.js"></script>
<!-- Highlight.jsの場合は <script>hljs.highlightAll();</script> -->
```

ただし、上記の方法はそのまま React で使うことは少なく、以下のように`useEffect`内で、かつ色つき表示する`<code>`要素を指定したうえで使うことが多いでしょう。

```javascript
useEffect(() => {
  Prism.highlightElement(elem);
  //Highlight.jsの場合 hljs.highlightElement(elem)
},
```

この方法にも課題はあり、`useEffect()`は初回レンダリング後に呼ばれるため、初回レンダリングの色なし表示と`useEffect()`後の色つき表示の間で画面のチラつきが発生する可能性があります。また、React の仮想 DOM 管理の外の世界で DOM ツリーを書き換えてしまうため、それが気になってしまう開発者もいるでしょう。

`useEffect`の問題点を避け、さらに現代の React らしく Server Side Rendering や Server Component といったサーバー側処理を活かそうとすると、Prism.js や Highlight.js の Node API を使うことになります。使い方は以下のとおりですが、問題はどちらも出力が HTML 「文字列」になってしまうことです。

```js
//Prism.js, htmlはHTML文字列
const html = Prism.highlight(code, Prism.languages.javascript, "javascript");

//Highlight.js, htmlはHTML文字列
const html = hljs.highlightAuto(code).value;
```

HTML 文字列はそのままでは React コンポーネントにはならないため、React の`dangerouslySetInnerHTML`を使うことになります。`dangerously`という名前から想起される通り、これを積極的に使いたがる開発者は少ないでしょう。

まとめると Prism.js や Highlight.js を React アプリで直接使う場合以下のどちらかを選択することになり、どちらにも課題が残ってしまいます。

- サーバー側で`dangerouslySetInnerHTML`を呼び出す
- クライアント側で`useEffect()`の内部から` Prism.highlightElement()`や`hljs.highlightElement()`を呼び出す

これらの課題を解決しようと作り込みをしていると、結局は React Syntax Highlighter が内部で行っていることと同じものを再発明することになりがちです。

一方で課題の解決は目指さず、多少の問題に目をつむるなら Prism.js や Highlight.js を React と組み合わせて使えるかもしれませんが、それなら React Syntax Highlighter を使えばもっと簡単なうえ、上記の問題も避けられます。

React Syntax Higlighter では実現できなかった機能にこだわりたい場合、次の選択肢が有用になります。

### 自力で<pre><code>内に<span>を追加

- Read-Only な選択肢には ◎
- 現代的な React 対応 ◎
- 上級者向けの選択肢で、多くの時間と高度な実装能力が要求される

この選択肢を紹介する前にことわっておくべきことは、これは上級者向けの選択肢であり、かつ多くの開発時間を要求するということです。そこまでの自信と時間的余裕がない場合は、React Syntax Highlighter の提供する機能のみで妥協するのが、本記事としてはおすすめです。それでも自力実装したいというチャレンジ精神あふれる開発者は、ぜひ以下の文章におつき合いいただければと思います。

React Syntax Highlighter には備わっていない機能や実現しづらい機能が必要な場合、その部分は自力で作り込むことになります。なぜ React Syntax Higlighter では実現しづらい機能があるのか？というと「`<pre><code>`タグの内部に自由にアクセスできない」ことが大きな理由だと考えられます。内部に自由にアクセスできないので「特定行のソースコードに上に重なるように要素を配置する」といったことが難しくなります。

TODO: 画像再掲

自力で実装する場合、ソースコードの色つき表示は`<pre><code>`タグで囲んだ内部に`<span>`タグを大量に追加するので、大まかには以下のような JSX を記述することになります。

```jsx
return (
  <pre className="...">
    <code>
      {srcCodeTokens.map(token => <span key={...} className={...}>{...}</span>)}
    </code>
  </pre>
```

ソースコードをトークンに分割し、トークンごとに`<span>`で囲んで色付き表示します。Prism.js に「This is the heart of Prism」とあるように、ソースコードの構文解析とトークンの生成こそがソースコードを色付き表示する際の最重要ロジックです。

React Syntax Highlighter では HTML 文字列ではなく JavaScript object で表現された AST を扱うために、refractor(for Prism.js) と lowlight(for Higlight.js)を使っています。

自力で実装する場合も、refractor(for Prism.js) と lowlight(for Higlight.js)を利用すれば同じことができます。そして React Syntax Highlighter という優れた参考例があるので、そのソースコードを参考にして refractor や lowlight の使い方を学び、あとは React Syntax Highlighter で実現できなかった部分だけを作り込めばよくなります。

（特に行ハイライトする場合）ソースコードを 1 行 1 行分割し (`srcLines`) それをトークンごとに分割 (`line.tokens`)

### Gist と GitHub embed (埋め込みサービス)

- Read-Only な選択肢には ◎
- 現代的な React に対応は ✕
- GitHub 公式の埋め込みサービスは Gist のみ、そして自由度が低い

ここでの「埋め込みサービス」とは、外部サービスに投稿したソースコードを自分の React アプリに表示できるものを指します。Read-Only な選択肢としては、GitHub のみを紹介します。（Editable な CodePen などは後で紹介します。）

実は、GitHub の本サイト(https://github.com) には埋め込み機能がないため、公式の埋め込みを行うには Gist (https://gist.github.com/) を使用する必要があります。Gist に投稿し直す手間はありますが、その作業自体は数秒で済むため、大きな負担にはならないでしょう。

Gist 公式の埋め込みコードは以下のようにシンプルな`<script>`タグ 1 つのみです。

```
<script src="https://gist.github.com/richardimaoka/5069d6448bb6245b579a661afdffcd47.js"></script>
```

このスクリプトは内部で `document.write` ([MDN](https://developer.mozilla.org/en-US/docs/Web/API/Document/write)) を利用して DOM ツリーの最後尾に埋め込み部分を追加します。つまり、埋め込み位置をどこにするか制御できませんし、Browser API である`document.write`に依存しているので、Server Side Rendering や Server Component との相性も悪いです。

CodePen なら書き込みも、あとから紹介
CodeSandbox

## Editable 系の選択肢

### 埋め込み系サービス

### Monaco Editor

### Ace Editor, CodeMirror
